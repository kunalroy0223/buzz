<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Dashboard</title>
    <link rel="stylesheet" href="Team_dash.css">
    <link rel="shortcut icon" href="bell.png" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <style>
        /* Center the buzzer container */
        .buzzer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .buzzer-btn {
            padding: 20px 40px;
            font-size: 2rem;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background-color: #4CAF50;
            color: white;
            transition: background 0.3s;
        }

        .buzzer-btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .buzzer-btn:hover:not(:disabled) {
            background-color: #45a049;
        }

        #buzzerStatus {
            margin-top: 20px;
            font-size: 1.2rem;
        }

        #stopwatch {
            font-size: 2rem;
            margin-top: 20px;
            color: #ff4500;
            display: none; /* Initially hidden */
        }
    </style>
</head>

<body>

<div class="background">
    <nav class="navbar">
        <div class="teamName" id="teamNameDisplay"></div>
        <div class="hamburger" id="hamburger">
            <div class="line1"></div>
            <div class="line2"></div>
            <div class="line3"></div>
        </div>
        <ul class="nav-links" id="navLinks">
            <li><button class="join-button" onclick="logout()">Logout</button></li>
        </ul>
    </nav>

    <!-- Buzzer Section (Centered) -->
    <div class="buzzer-container">
        <h1>Press the Buzzer!</h1>
        <button id="buzzer" class="buzzer-btn" onclick="pressBuzzer()" disabled>üîî Buzz!</button>
        <p id="buzzerStatus">Waiting to buzz...</p>
        <div id="stopwatch">‚è±Ô∏è 0 ms</div>
    </div>
</div>

<script>
    // ‚úÖ Toggle Mobile Menu
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.getElementById('navLinks');

    hamburger.addEventListener('click', () => {
        navLinks.classList.toggle('open');
        hamburger.classList.toggle('toggle');
    });

    function closeMenu() {
        navLinks.classList.remove('open');
        hamburger.classList.remove('toggle');
    }

    // ‚úÖ Initialize Socket.io (Ensure your server is running on port 3000)
    const socket = io('http://localhost:3000');

    // ‚úÖ Fetch Team Data from Session Storage
    const teamName = sessionStorage.getItem('teamName') || "Team_X";
    document.getElementById('teamNameDisplay').textContent = `Team: ${teamName}`;

    // ‚úÖ Stopwatch Variables
    let buzzerPressed = false;
    let startTime = performance.now();
    let elapsedTime = 0;
    let stopwatchInterval;

    // ‚è±Ô∏è Start Stopwatch only when Buzzer is Active
    function startStopwatch() {
        stopwatchInterval = setInterval(() => {
            if (!buzzerPressed) {
                const currentTime = performance.now() - startTime + elapsedTime;
                document.getElementById('stopwatch').textContent = `‚è±Ô∏è ${Math.floor(currentTime)} ms`;
            }
        }, 1); // Update every millisecond
    }

    // üõéÔ∏è Handle Buzzer Press (Send Directly to Admin via Socket.io)
    function pressBuzzer() {
        if (buzzerPressed) return; // Prevent multiple clicks

        buzzerPressed = true;
        document.getElementById('buzzer').disabled = true;

        const currentTime = performance.now() - startTime + elapsedTime; // High precision stopwatch
        document.getElementById('buzzerStatus').textContent = `‚è≥ Buzzer Pressed at ${Math.floor(currentTime)} ms!`;

        // üõ¢Ô∏è Send Data to Backend via Socket.io (No Firestore)
        socket.emit('buzzerPressed', { teamName, timestamp: Math.floor(currentTime) });

        console.log(`‚úÖ Sent buzzer data: Team - ${teamName}, Time - ${Math.floor(currentTime)} ms`);
    }

    // üîÑ Listen for Reset Event from Admin (Reset Stopwatch and Buzzer)
    socket.on('resetBuzzer', () => {
        buzzerPressed = false;
        elapsedTime = 0; // Reset the elapsed time
        startTime = performance.now(); // Reset stopwatch
        document.getElementById('buzzer').disabled = true; // Disable buzzer
        document.getElementById('buzzerStatus').textContent = '‚úÖ Waiting for Admin to activate buzzer!';
        document.getElementById('stopwatch').style.display = 'none'; // Hide stopwatch initially
    });

    // üîÑ Listen for Activate Buzzer Event from Admin (Enable the buzzer and start stopwatch)
    socket.on('activateBuzzer', () => {
        document.getElementById('buzzer').disabled = false; // Enable buzzer when admin activates it
        document.getElementById('buzzerStatus').textContent = '‚úÖ Ready to buzz!';
        buzzerPressed = false; // Reset buzzer press status
        startTime = performance.now(); // Reset stopwatch
        document.getElementById('stopwatch').style.display = 'block'; // Show stopwatch
        startStopwatch(); // Start the stopwatch
    });

    // üîÑ Listen for Deactivate Buzzer Event from Admin (Disable the buzzer)
    socket.on('deactivateBuzzer', () => {
        document.getElementById('buzzer').disabled = true; // Disable buzzer when admin deactivates it
        document.getElementById('buzzerStatus').textContent = '‚ùå Buzzer Deactivated by Admin!';
        document.getElementById('stopwatch').style.display = 'none'; // Hide stopwatch
        buzzerPressed = true; // Prevent further buzzer presses
    });

    // üîí Logout Function (Clear Session Storage)
    function logout() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Dashboard</title>
    <link rel="stylesheet" href="Team_dash.css">
    <link rel="shortcut icon" href="bell.png" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <style>
        .buzzer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .buzzer-btn {
            padding: 20px 40px;
            font-size: 2rem;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background-color: #4CAF50;
            color: white;
            transition: background 0.3s;
        }

        .buzzer-btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .buzzer-btn:hover:not(:disabled) {
            background-color: #45a049;
        }

        #buzzerStatus {
            margin-top: 20px;
            font-size: 1.2rem;
        }

        #stopwatch {
            font-size: 2rem;
            margin-top: 20px;
            color: #ff4500;
            display: none;
        }
    </style>
</head>

<body>

<div class="background">
    <nav class="navbar">
        <div class="teamName" id="teamNameDisplay"></div>
        <div class="hamburger" id="hamburger">
            <div class="line1"></div>
            <div class="line2"></div>
            <div class="line3"></div>
        </div>
        <ul class="nav-links" id="navLinks">
            <li><button class="join-button" onclick="logout()">Logout</button></li>
        </ul>
    </nav>

    <!-- Buzzer Section -->
    <div class="buzzer-container">
        <h1>Press the Buzzer!</h1>
        <button id="buzzer" class="buzzer-btn" onclick="pressBuzzer()" disabled>üîî Buzz!</button>
        <p id="buzzerStatus">Waiting to buzz...</p>
        <div id="stopwatch">‚è±Ô∏è 0 ms</div>
    </div>
</div>

<script>
    // ‚úÖ Toggle Mobile Menu
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.getElementById('navLinks');

    hamburger.addEventListener('click', () => {
        navLinks.classList.toggle('open');
        hamburger.classList.toggle('toggle');
    });

    // ‚úÖ Initialize Socket.io (Ensure your server is running correctly)
    const socket = io(
        window.location.hostname === 'localhost'
            ? 'http://localhost:3000' // Local development
            : 'https://quickbuzz-dtle.onrender.com' // Deployed backend
    );

    // ‚úÖ Fetch Team Data from Session Storage
    const teamName = sessionStorage.getItem('teamName') || "Team_X";
    document.getElementById('teamNameDisplay').textContent = `Team: ${teamName}`;

    // Stopwatch Variables
    let buzzerPressed = false;
    let startTime = 0;
    let stopwatchInterval;

    // ‚è±Ô∏è Start Stopwatch only when Buzzer is Active
    function startStopwatch() {
        startTime = performance.now();
        document.getElementById('stopwatch').style.display = 'block';

        stopwatchInterval = setInterval(() => {
            if (!buzzerPressed) {
                const elapsedTime = performance.now() - startTime;
                document.getElementById('stopwatch').textContent = `‚è±Ô∏è ${Math.floor(elapsedTime)} ms`;
            }
        }, 1);
    }

    // üõéÔ∏è Handle Buzzer Press (Send Directly to Admin via Socket.io)
    function pressBuzzer() {
        if (buzzerPressed) return; // Prevent multiple clicks

        buzzerPressed = true;
        document.getElementById('buzzer').disabled = true;

        // üõ¢Ô∏è Send Data to Backend (server handles the timestamp for accuracy)
        socket.emit('buzzerPressed', { teamName });

        document.getElementById('buzzerStatus').textContent = `‚è≥ Buzzer Pressed! Waiting for confirmation...`;
        clearInterval(stopwatchInterval);
    }

    // üîÑ Listen for Reset Event from Admin
    socket.on('resetBuzzer', () => {
        buzzerPressed = false;
        document.getElementById('buzzer').disabled = true;
        document.getElementById('buzzerStatus').textContent = '‚úÖ Waiting for Admin to activate buzzer!';
        document.getElementById('stopwatch').style.display = 'none';
        clearInterval(stopwatchInterval);
    });

    // üîÑ Listen for Activate Buzzer Event from Admin
    socket.on('activateBuzzer', () => {
        buzzerPressed = false;
        document.getElementById('buzzer').disabled = false;
        document.getElementById('buzzerStatus').textContent = '‚úÖ Ready to buzz!';
        startStopwatch();
    });

    // üîÑ Listen for Deactivate Buzzer Event from Admin
    socket.on('deactivateBuzzer', () => {
        buzzerPressed = true;
        document.getElementById('buzzer').disabled = true;
        document.getElementById('buzzerStatus').textContent = '‚ùå Buzzer Deactivated by Admin!';
        clearInterval(stopwatchInterval);
    });

    // üîí Logout Function
    function logout() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }
</script>

</body>
</html>

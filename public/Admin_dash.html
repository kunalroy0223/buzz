<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="shortcut icon" href="bell.png" type="image/x-icon">

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
        }

        .left-section {
            flex: 2;
            padding: 20px;
            background: #fff;
            border-right: 1px solid #ddd;
        }

        .right-section {
            flex: 1;
            padding: 20px;
            background: #fafafa;
        }

        h1, h2 {
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #4CAF50;
            color: white;
        }

        #resetButton, #logoutButton, #activateBuzzerButton {
            padding: 10px 20px;
            margin: 20px 10px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #resetButton {
            background: #2196F3;
            color: white;
        }

        #logoutButton {
            background: #FF5733;
            color: white;
        }

        #activateBuzzerButton {
            background: #FFC107;
            color: white;
        }

        #deactivateButton {
            background: #FF5722;
            color: white;
        }
    </style>
</head>

<body>
    <div class="left-section">
        <h1>Admin Dashboard</h1>
    </div>

    <div class="right-section">
        <h2>Leaderboard</h2>
        <table id="leaderboard">
            <thead>
                <tr>
                    <th>Position</th>
                    <th>Team Name</th>
                    <th>Timestamp (ms)</th>
                </tr>
            </thead>
            <tbody id="leaderboardBody">
                <!-- Buzzer Data will be populated here -->
            </tbody>
        </table>

        <button id="resetButton" onclick="resetBuzzer()">Reset Buzzers</button>
        <button id="activateBuzzerButton" onclick="activateBuzzer()">Activate Buzzer</button>
        <button id="deactivateButton" onclick="deactivateBuzzer()" style="display: none;">Deactivate Buzzer</button>
        <button id="logoutButton" onclick="handleLogout()">Logout</button>
    </div>

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Initialize Socket.IO Connection
        const socket = io(
            window.location.hostname === 'localhost'
                ? 'http://localhost:3000'  // Local development
                : 'https://quickbuzz-dtle.onrender.com'  // Deployed backend
        );

        const leaderboardBody = document.getElementById("leaderboardBody");
        let buzzerData = [];
        let buzzerActivated = false; // Track if the buzzer is activated

        // ‚úÖ Listen for buzzerUpdate event (with timestamp)
        socket.on("buzzerUpdate", (data) => {
            console.log("üîî Buzzer Data Received:", data);

            // Ensure only unique team entries are added
            if (!buzzerData.some(item => item.teamName === data.teamName)) {
                buzzerData.push(data);
                updateLeaderboard();
            }
        });

        // ‚úÖ Listen for resetBuzzer event (clears the board)
        socket.on("resetBuzzer", () => {
            console.log("üîÑ Buzzers Reset");
            buzzerData = [];
            updateLeaderboard();
        });

        // üìä Update the leaderboard with formatted time
        function updateLeaderboard() {
            leaderboardBody.innerHTML = "";

            // Sort by the fastest (lowest timestamp) first
            buzzerData.sort((a, b) => a.timestamp - b.timestamp);

            buzzerData.forEach((item, index) => {
                const { teamName, timestamp } = item;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${teamName}</td>
                    <td>‚è±Ô∏è ${formatTime(timestamp)}</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }

        // ‚è≥ Helper: Format time (e.g., 1010 ms)
        function formatTime(ms) {
            return `${ms} ms`;
        }

        // üõë Reset Buzzer (admin control)
        function resetBuzzer() {
            socket.emit("resetBuzzer");
            buzzerData = [];
            updateLeaderboard();
            console.log("üì£ Reset event sent to server.");
        }

        // üö® Activate Buzzer (enable for teams)
        function activateBuzzer() {
            if (!buzzerActivated) {
                socket.emit("activateBuzzer");
                buzzerActivated = true;
                document.getElementById("activateBuzzerButton").style.display = "none";
                document.getElementById("deactivateButton").style.display = "inline-block";
                console.log("üì£ Buzzer activated for teams.");
            }
        }

        // üõë Deactivate Buzzer (disable for teams)
        function deactivateBuzzer() {
            socket.emit("deactivateBuzzer");
            buzzerActivated = false;
            document.getElementById("deactivateButton").style.display = "none";
            document.getElementById("activateBuzzerButton").style.display = "inline-block";
            console.log("üì£ Buzzer deactivated.");
        }

        // üîê Handle Admin Logout
        function handleLogout() {
            window.location.href = "index.html";
        }
    </script>

</body>

</html>
